"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=createTaskHandler,require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/es6.array.from"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.string.iterator"),require("core-js/modules/es6.map"),require("core-js/modules/es6.object.freeze"),require("regenerator-runtime/runtime"),require("core-js/modules/es7.symbol.async-iterator"),require("core-js/modules/es6.symbol"),require("core-js/modules/es6.promise");var _constants=require("./constants"),_defer=_interopRequireDefault(require("./defer"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _awaitAsyncGenerator(a){return new _AwaitValue(a)}function _wrapAsyncGenerator(a){return function(){return new _AsyncGenerator(a.apply(this,arguments))}}function _AsyncGenerator(a){function b(d,e){try{var f=a[d](e),g=f.value,h=g instanceof _AwaitValue;Promise.resolve(h?g.wrapped:g).then(function(a){return h?void b("next",a):void c(f.done?"return":"normal",a)},function(a){b("throw",a)})}catch(a){c("throw",a)}}function c(a,c){switch(a){case"return":d.resolve({value:c,done:!0});break;case"throw":d.reject(c);break;default:d.resolve({value:c,done:!1});}d=d.next,d?b(d.key,d.arg):e=null}var d,e;this._invoke=function(a,c){return new Promise(function(f,g){var h={key:a,arg:c,resolve:f,reject:g,next:null};e?e=e.next=h:(d=e=h,b(a,c))})},"function"!=typeof a.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(_AsyncGenerator.prototype[Symbol.asyncIterator]=function(){return this}),_AsyncGenerator.prototype.next=function(a){return this._invoke("next",a)},_AsyncGenerator.prototype.throw=function(a){return this._invoke("throw",a)},_AsyncGenerator.prototype.return=function(a){return this._invoke("return",a)};function _AwaitValue(a){this.wrapped=a}function createTaskRef(a,b,c,d){var e;b.cancel(a);var f,g,h,i,j,k=function(){return g||(g=new Promise(function(a,b){h=[a,b]}))},l=(e={get result(){return l.status.complete?i:void 0},get promise(){return c?function(){var a=_wrapAsyncGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:a.prev=0;case 1:if(!l.status.complete){a.next=4;break}return a.abrupt("break",13);case 4:return k(),a.next=7,_awaitAsyncGenerator(g);case 7:return a.next=9,l;case 9:h=void 0,g=void 0,a.next=1;break;case 13:return a.abrupt("return",l);case 14:return a.prev=14,h=void 0,g=void 0,a.finish(14);case 18:case"end":return a.stop();}},a,this,[[0,,14,18]])}));return function(){return a.apply(this,arguments)}}():g?function(){return g}:(f=f||function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,!l.status.complete){a.next=3;break}return a.abrupt("return",l);case 3:return k(),a.next=6,g;case 6:return a.abrupt("return",l);case 9:throw a.prev=9,a.t0=a["catch"](0),l.status.error=!0,i=a.t0,a.t0;case 14:return a.prev=14,h=void 0,g=void 0,a.finish(14);case 18:case"end":return a.stop();}},a,this,[[0,9,14,18]])}));return function(){return a.apply(this,arguments)}}(),f)},status:{complete:!1,error:!1,cancelled:!1}},_defineProperty(e,_constants.TASK_CANCELLED,function(b){l.status.complete||(i=_constants.TASK_CANCELLED,l.status.cancelled=!0,l.status.complete=!0,g&&h[0](l),j&&("function"==typeof j.cancelled?b.push(j.cancelled()):"production"!==process.env.NODE_ENV&&console.warn("[WARN] | task-handler | Async Job \"".concat(a,"\" was cancelled but provided no \"cancelled\" handler."))))}),_defineProperty(e,_constants.EXECUTE_RESULT,function(a,b){if(!l.status.complete&&(i=b,c||(l.status.complete=!0),g)){if(a){var d="object"===_typeof(a)?a:new Error(a);return d.taskRef=l,h[1](d)}return h[0](l)}}),_defineProperty(e,"id",a),_defineProperty(e,"task",b),_defineProperty(e,"resolve",function b(a){return l[_constants.EXECUTE_RESULT](void 0,a)}),_defineProperty(e,"reject",function b(a){return l[_constants.EXECUTE_RESULT](a)}),_defineProperty(e,"cancel",function c(){i=_constants.TASK_CANCELLED,l.status.cancelled=!0,b.cancel(a)}),e);return d&&(j=d[0].apply(l,d[1]),l.promise().catch(_constants.NOOP),j.start.call(l,l)),Object.freeze(l)}function createTaskHandler(){function a(){return d?d:(d=(0,_defer.default)(e),d)}function b(a,b){if(e.has(a)){var c=e.get(a),d=_slicedToArray(c,2),f=d[0],g=d[1];g(),e.delete(a),f[_constants.TASK_CANCELLED](b)}}function c(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:_constants.STATIC_EMPTY_ARRAY;try{var d="function"==typeof b?b.apply(void 0,[a].concat(_toConsumableArray(c))):void 0;a[_constants.EXECUTE_RESULT](void 0,d)}catch(b){a[_constants.EXECUTE_RESULT](b)}}var d,e=new Map,f=Object.freeze({get size(){return e.size},after:function j(a,b,d,g){var h=createTaskRef(a,f),i=setTimeout(c,b,h,d,g);return e.set(a,[h,function(){return clearTimeout(i)}]),h},defer:function j(b,d,g){var h=createTaskRef(b,f),i=a().add(h,function(){return c(h,d,g)});return e.set(b,[h,function(){return i()}]),h},every:function j(a,b,d,g){var h=createTaskRef(a,f,!0),i=setInterval(c,b,h,d,g);return e.set(a,[h,function(){return clearInterval(i)}]),h},everyNow:function l(b,d,g,h){var i=createTaskRef(b,f,!0),j=setInterval(c,d,i,g,h),k=a().add(b,function(){return c(i,g,h)});return e.set(b,[i,function(){clearInterval(j),k()}]),i},job:function g(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:_constants.STATIC_EMPTY_ARRAY,d=createTaskRef(a,f,!1,[b,c]);return e.set(a,[d,_constants.NOOP]),d},cancel:function f(){for(var a=[],c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];return d.forEach(function(c){return b(c,a)}),{promise:function b(){return Promise.all(a)}}},clear:function a(){return f.cancel.apply(f,_toConsumableArray(Array.from(e.keys())))}});return f}